{% extends "layout.html" %}

{% block title %}
    Home
{% endblock %}

{% block main %}
<div class="p-6 bg-gray-50 min-h-screen">
    <!-- Header Section -->
    <div class="flex items-center justify-between mb-6">
        <h1 class="text-2xl font-bold text-gray-800" data-translate="home.title">Problem Reports</h1>
        <!-- Feature Selector -->
        <div class="ml-auto">
            <label for="featureSelect" class="mr-2 font-medium text-gray-700" data-translate="home.add_column">Add Column:</label>
            <select id="featureSelect" class="px-2 py-1 border rounded shadow-sm text-sm">
                <option value="" disabled selected data-translate="home.select_feature">Select a feature</option>
                <option value="priority" data-translate="features.priority">Priority</option>
                <option value="created_at" data-translate="features.created_at">Created At</option>
                <option value="assigned_to" data-translate="features.assigned_to">Assigned To</option>
                <option value="severity" data-translate="features.severity">Severity</option>
            </select>
        </div>
    </div>

    <!-- Table Container -->
    <div class="overflow-x-auto shadow-lg rounded-lg bg-white">
        <table id="problemTable" class="min-w-full divide-y divide-gray-200 text-sm">
            <thead class="bg-gray-100">
                <tr>
                    <th class="px-6 py-3 text-left font-semibold text-gray-600 uppercase tracking-wider" data-translate="home.columns.df_number">DF Number</th>
                    <th class="px-6 py-3 text-left font-semibold text-gray-600 uppercase tracking-wider" data-translate="home.columns.project">Project</th>
                    <th class="px-6 py-3 text-left font-semibold text-gray-600 uppercase tracking-wider" data-translate="home.columns.manager">Manager</th>
                    <th class="px-6 py-3 text-left font-semibold text-gray-600 uppercase tracking-wider" data-translate="home.columns.reason">Reason</th>
                    <th class="px-6 py-3 text-left font-semibold text-gray-600 uppercase tracking-wider" data-translate="home.columns.status">Status</th>
                    <th class="px-6 py-3 text-left font-semibold text-gray-600 uppercase tracking-wider" data-translate="home.columns.actions">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
                {% for p in data %}
                <tr class="hover:bg-gray-50 transition cursor-pointer" onclick="openDetails('{{ p.df_number }}')">
                    <td class="px-6 py-4 font-medium text-gray-900">{{ p.df_number }}</td>
                    <td class="px-6 py-4 text-gray-700">{{ p.project_number }}</td>
                    <td class="px-6 py-4 text-gray-700">{{ p.manager_name }}</td>
                    <td class="px-6 py-4 text-red-500 font-semibold">{{ p.reason }}</td>
                    <td class="px-6 py-4">
                        {% if p.status == "Completed" %}
                            <span class="px-2 py-1 rounded-lg text-xs bg-green-100 text-green-800" data-translate="status.completed">Completed</span>
                        {% elif p.status == "Pending" %}
                            <span class="px-2 py-1 rounded-lg text-xs bg-yellow-100 text-yellow-800" data-translate="status.pending">Pending</span>
                        {% else %}
                            <span class="px-2 py-1 rounded-lg text-xs bg-red-100 text-red-800" data-translate="status.issue">Issue</span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4">
                        <button class="text-blue-600 hover:underline" data-translate="table.view">View</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>


        
    </div>

    <!-- Sidebar (Hidden by default, opens on row click) -->
    <div id="detailsPanel" class="fixed top-0 right-0 w-1/3 h-full bg-white shadow-lg p-6 hidden overflow-y-auto">
        <button onclick="closeDetails()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700">âœ–</button>
        <h2 class="text-xl font-bold mb-4" data-translate="sidebar.title">Problem Report Details</h2>
        <div id="detailsContent">
            <p class="text-gray-600" data-translate="sidebar.placeholder">Select a report to view details...</p>
        </div>
    </div>


    <!-- Chatbox Button -->
    <button id="chatboxBtn" class="fixed bottom-6 right-6 p-4 bg-orange-600 text-white rounded-full shadow-lg">
    ðŸ’¬
    </button>

    <!-- Chatbox Modal -->
    <div id="chatbox" class="fixed bottom-0 right-0 w-80 bg-white shadow-lg rounded-t-lg p-4 hidden">
    <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold">DF Problem Summary</h3>
        <button id="closeChat" class="text-gray-500">âœ–</button>
    </div>
    <div id="chatContent" class="mb-4">
        <p class="text-gray-600">Select a report to view details...</p>
    </div>
    <textarea id="userInput" class="w-full p-2 border rounded mb-4" placeholder="Ask something..." rows="3"></textarea>
    <button id="sendMessage" class="w-full p-2 bg-blue-600 text-white rounded">Send</button>
    </div>

</div>

<script>
    const problemData = {{ data | tojson }};
</script>


<script>
    const featureSelect = document.getElementById("featureSelect");
    const table = document.getElementById("problemTable");

    // Example extra data for demonstration
    const extraData = {
        priority: ["High", "Medium", "Low", "High", "Medium"],
        created_at: ["2025-08-22", "2025-08-21", "2025-08-20", "2025-08-19", "2025-08-18"],
        assigned_to: ["Alice", "Bob", "Charlie", "Diana", "Eve"],
        severity: ["Critical", "Moderate", "Low", "Critical", "Moderate"]
    };

    featureSelect.addEventListener("change", () => {
        const feature = featureSelect.value;
        const headers = Array.from(table.querySelectorAll("thead th")).map(h => h.dataset.translate || h.innerText.toLowerCase());
        if (headers.includes(feature)) {
            alert("This feature is already added!");
            return;
        }

        // Add column header
        const headerRow = table.querySelector("thead tr");
        const newTh = document.createElement("th");
        newTh.innerText = feature.charAt(0).toUpperCase() + feature.slice(1);
        newTh.classList.add("px-6","py-3","text-left","font-semibold","text-gray-600","uppercase","tracking-wider");
        newTh.dataset.translate = `features.${feature}`;
        headerRow.appendChild(newTh);

        // Add column cells to each row
        const rows = table.querySelectorAll("tbody tr");
        rows.forEach((row, i) => {
            const newTd = document.createElement("td");
            newTd.classList.add("px-6","py-4");
            newTd.innerText = extraData[feature][i] || "-";
            row.appendChild(newTd);
        });
    });

    function openDetails(df_number) {
        const detailsPanel = document.getElementById("detailsPanel");
        const detailsContent = document.getElementById("detailsContent");

        const problem = problemData.find(p => p.df_number === df_number);
        if (!problem) return;

        let html = `
            <p><strong data-translate="sidebar.df_number">DF Number:</strong> ${problem.df_number}</p>
            <p><strong data-translate="sidebar.project">Project:</strong> ${problem.project_number}</p>
            <p><strong data-translate="sidebar.manager">Manager:</strong> ${problem.manager_name}</p>
            <p><strong data-translate="sidebar.reason">Reason:</strong> ${problem.reason}</p>
            <p><strong data-translate="sidebar.description">Description:</strong></p>
            <p>${problem.description || "-"}</p>
            <p><strong data-translate="sidebar.photos">Photos:</strong></p>
            <div class="flex flex-wrap gap-2 mt-2">
        `;

        if (!problem.photo_urls || problem.photo_urls.length === 0) {
            html += `<p class="text-gray-500">No photos available</p>`;
        } else {
            problem.photo_urls.forEach(photo => {
                html += `<img src="${photo}" class="w-24 h-24 object-cover rounded shadow" />`;
            });
        }

        html += `</div>`;

        detailsContent.innerHTML = html;
        detailsPanel.classList.remove("hidden");
    }




    function closeDetails() {
        document.getElementById("detailsPanel").classList.add("hidden");
    }

    document.getElementById("llmChatHeader").addEventListener("click", () => {
        const content = document.getElementById("llmChatContent");
        const inputArea = document.getElementById("llmChatInput").parentElement;
        const chatBox = document.getElementById("llmChatBox");
        if (content.style.display === "none") {
            content.style.display = "block";
            inputArea.style.display = "flex";
            chatBox.style.height = "400px";
        } else {
            content.style.display = "none";
            inputArea.style.display = "none";
            chatBox.style.height = "40px";
        }
    });

    document.getElementById("llmChatSend").addEventListener("click", async () => {
        const input = document.getElementById("llmChatInput");
        const msg = input.value.trim();
        if (!msg) return;

        const chatContent = document.getElementById("llmChatContent");
        chatContent.innerHTML += `<p><strong>You:</strong> ${msg}</p>`;
        input.value = "";

        // Send to Flask
        const response = await fetch("/llm_summary", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ query: msg })
        });

        const data = await response.json();
        chatContent.innerHTML += `<p><strong>LLM:</strong> ${data.answer}</p>`;
        chatContent.scrollTop = chatContent.scrollHeight;
    });
</script>

<script>
  const chatboxBtn = document.getElementById("chatboxBtn");
  const chatbox = document.getElementById("chatbox");
  const closeChat = document.getElementById("closeChat");
  const sendMessage = document.getElementById("sendMessage");
  const userInput = document.getElementById("userInput");
  const chatContent = document.getElementById("chatContent");

  // Toggle chatbox visibility
  chatboxBtn.addEventListener("click", () => {
    chatbox.classList.toggle("hidden");
  });

  closeChat.addEventListener("click", () => {
    chatbox.classList.add("hidden");
  });

  // Handle message sending
  sendMessage.addEventListener("click", async () => {
    const query = userInput.value.trim();
    if (query) {
      const response = await fetch("/summarize", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ query }),
      });
      const data = await response.json();
      chatContent.innerHTML = `<p class="text-gray-600">${data.summary}</p>`;
      userInput.value = "";
    }
  });

  
</script>

{% endblock %}
