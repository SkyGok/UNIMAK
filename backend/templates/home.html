{% extends "layout.html" %}

{% block title %}
    Home
{% endblock %}

{% block main %}
<div class="p-6 bg-gray-50 min-h-screen">
    <!-- Header Section -->
    <div class="flex items-center justify-between mb-6">
        <h1 class="text-2xl font-bold text-gray-800" data-translate="home.title">Problem Reports</h1>
        <!-- Feature Selector -->
        <div class="ml-auto">
            <label for="featureSelect" class="mr-2 font-medium text-gray-700" data-translate="home.add_column">Add Column:</label>
            <select id="featureSelect" class="px-2 py-1 border rounded shadow-sm text-sm">
                <option value="" disabled selected data-translate="home.select_feature">Select a feature</option>
                <option value="priority" data-translate="features.priority">Priority</option>
                <option value="created_at" data-translate="features.created_at">Created At</option>
                <option value="assigned_to" data-translate="features.assigned_to">Assigned To</option>
                <option value="severity" data-translate="features.severity">Severity</option>
            </select>
        </div>
    </div>

    <!-- Table Container -->
    <div class="overflow-x-auto shadow-lg rounded-lg bg-white">
        <table id="problemTable" class="min-w-full divide-y divide-gray-200 text-sm">
            <thead class="bg-gray-100">
                <tr>
                    <th class="px-6 py-3 text-left font-semibold text-gray-600 uppercase tracking-wider" data-translate="table.df_number">DF Number</th>
                    <th class="px-6 py-3 text-left font-semibold text-gray-600 uppercase tracking-wider" data-translate="table.project">Project</th>
                    <th class="px-6 py-3 text-left font-semibold text-gray-600 uppercase tracking-wider" data-translate="table.manager">Manager</th>
                    <th class="px-6 py-3 text-left font-semibold text-gray-600 uppercase tracking-wider" data-translate="table.reason">Reason</th>
                    <th class="px-6 py-3 text-left font-semibold text-gray-600 uppercase tracking-wider" data-translate="table.status">Status</th>
                    <th class="px-6 py-3 text-left font-semibold text-gray-600 uppercase tracking-wider" data-translate="table.actions">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
                {% for p in data %}
                <tr class="hover:bg-gray-50 transition cursor-pointer" onclick="openDetails('{{ p.df_number }}')">
                    <td class="px-6 py-4 font-medium text-gray-900">{{ p.df_number }}</td>
                    <td class="px-6 py-4 text-gray-700">{{ p.project }}</td>
                    <td class="px-6 py-4 text-gray-700">{{ p.manager }}</td>
                    <td class="px-6 py-4 text-red-500 font-semibold">{{ p.reason }}</td>
                    <td class="px-6 py-4">
                        {% if p.status == "Completed" %}
                            <span class="px-2 py-1 rounded-lg text-xs bg-green-100 text-green-800" data-translate="status.completed">Completed</span>
                        {% elif p.status == "Pending" %}
                            <span class="px-2 py-1 rounded-lg text-xs bg-yellow-100 text-yellow-800" data-translate="status.pending">Pending</span>
                        {% else %}
                            <span class="px-2 py-1 rounded-lg text-xs bg-red-100 text-red-800" data-translate="status.issue">Issue</span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4">
                        <button class="text-blue-600 hover:underline" data-translate="table.view">View</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Sidebar (Hidden by default, opens on row click) -->
    <div id="detailsPanel" class="fixed top-0 right-0 w-1/3 h-full bg-white shadow-lg p-6 hidden overflow-y-auto">
        <button onclick="closeDetails()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700">âœ–</button>
        <h2 class="text-xl font-bold mb-4" data-translate="sidebar.title">Problem Report Details</h2>
        <div id="detailsContent">
            <p class="text-gray-600" data-translate="sidebar.placeholder">Select a report to view details...</p>
        </div>
    </div>
</div>

<script>
    const featureSelect = document.getElementById("featureSelect");
    const table = document.getElementById("problemTable");

    // Example extra data for demonstration
    const extraData = {
        priority: ["High", "Medium", "Low", "High", "Medium"],
        created_at: ["2025-08-22", "2025-08-21", "2025-08-20", "2025-08-19", "2025-08-18"],
        assigned_to: ["Alice", "Bob", "Charlie", "Diana", "Eve"],
        severity: ["Critical", "Moderate", "Low", "Critical", "Moderate"]
    };

    featureSelect.addEventListener("change", () => {
        const feature = featureSelect.value;
        const headers = Array.from(table.querySelectorAll("thead th")).map(h => h.dataset.translate || h.innerText.toLowerCase());
        if (headers.includes(feature)) {
            alert("This feature is already added!");
            return;
        }

        // Add column header
        const headerRow = table.querySelector("thead tr");
        const newTh = document.createElement("th");
        newTh.innerText = feature.charAt(0).toUpperCase() + feature.slice(1);
        newTh.classList.add("px-6","py-3","text-left","font-semibold","text-gray-600","uppercase","tracking-wider");
        newTh.dataset.translate = `features.${feature}`;
        headerRow.appendChild(newTh);

        // Add column cells to each row
        const rows = table.querySelectorAll("tbody tr");
        rows.forEach((row, i) => {
            const newTd = document.createElement("td");
            newTd.classList.add("px-6","py-4");
            newTd.innerText = extraData[feature][i] || "-";
            row.appendChild(newTd);
        });
    });

    function openDetails(df_number) {
        document.getElementById("detailsPanel").classList.remove("hidden");
        document.getElementById("detailsContent").innerHTML = `
            <p><strong data-translate="sidebar.loading">Loading details for:</strong> ${df_number}</p>
        `;
    }

    function closeDetails() {
        document.getElementById("detailsPanel").classList.add("hidden");
    }
</script>
{% endblock %}
